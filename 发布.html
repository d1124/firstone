
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>发布</title>
  <link rel="stylesheet" href="layui/css/layui.css">

    <script src="jquery-1.12.4.js"></script>
<script src="Bmob-2.2.5.min.js"></script>
</head>
<body>

  <fieldset class="layui-elem-field layui-field-title" style="margin-top: 50px;">
    <legend>批量处理事件</legend>
  </fieldset>
  <div class="layui-btn-container">
    <button class="layui-btn" lay-active="e1">初始化地区和三个班</button>
    <button class="layui-btn" lay-active="e2">初始化路线</button>
    <button class="layui-btn" lay-active="e3">路线和地区结合</button>
  </div>

  <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend>选择</legend>
  </fieldset>
  <div class="layui-btn-container">
    <button type="button" class="layui-btn" lay-demotransferactive="getData">发布当天任务</button>
    <button type="button" class="layui-btn" lay-demotransferactive="reload">自动选择</button>
  </div>
  <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
  <legend>A班</legend>
</fieldset>
<div id="test7" class="demo-transfer"></div>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
  <legend>B班</legend>
</fieldset>
<div id="test8" class="demo-transfer"></div>
<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
  <legend>C班</legend>
</fieldset>
<div id="test9" class="demo-transfer"></div>

<!-- 引入 layui.js 的 <script> 标签最好放置在 html 末尾 -->
<script src="layui/layui.js"></script>

<script>
layui.use(['transfer', 'layer', 'util'], function(){
  var $ = layui.$
  ,transfer = layui.transfer
  ,layer = layui.layer
  ,util = layui.util;

// Bmob.initialize("2ba7d49d6cd824c5", "981124");
Bmob.initialize("f1cdf3c708bde14d", "981124");
var data1 = [
{"value": "1001", "title": "李白","time":"1"}
,{"value": "2001", "title": "李白","time":"2"}
,{"value": "3001", "title": "李白","time":"3"}
,{"value": "1002", "title": "地点四","time":"1"}
,{"value": "1003", "title": "地点五","time":"1"}
,{"value": "1004", "title": "地点二","time":"1"}
,{"value": "1005", "title": "地点三","time":"1"}
,{"value": "1006", "title": "地点一","time":"1"}
,{"value": "2007", "title": "地点一","time":"2"}
,{"value": "2008", "title": "地点二","time":"2"}
,{"value": "3009", "title": "地点二","time":"3"}
]
var placelist=["地点一","地点二","地点三","李白","地点四","地点五"]
//实例调用
transfer.render({
  elem: '#test7'
  ,showSearch: true
  ,data: data1
  ,parseData: function(res){
  return {
    "value": res.value //数据值
    ,"title": res.title+"("+res.time+")" //数据标题
    ,"disabled": res.disabled  //是否禁用
    ,"checked": res.checked //是否选中
  }
}
  ,title: ['全部地点', 'A班选中地点']
  ,id: 'key1' //定义唯一索引
  ,value: ["1001"]
})

transfer.render({
  elem: '#test8'
  ,showSearch: true
  ,data: data1
  ,parseData: function(res){
  return {
    "value": res.value //数据值
    ,"title": res.title+"("+res.time+")" //数据标题
    ,"disabled": res.disabled  //是否禁用
    ,"checked": res.checked //是否选中
  }
}
  ,title: ['全部地点', 'B班选中地点']
  ,id: 'key2' //定义唯一索引
  ,value: ["1002"]
})


transfer.render({
  elem: '#test9'
  ,showSearch: true
  ,data: data1
  ,parseData: function(res){
  return {
    "value": res.value //数据值
    ,"title": res.title+"("+res.time+")" //数据标题
    ,"disabled": res.disabled  //是否禁用
    ,"checked": res.checked //是否选中
  }
}
  ,title: ['全部地点', 'C班选中地点']
  ,id: 'key3' //定义唯一索引
  ,value: ["2007"]
})


function selectlist(place,date,classtime){
  var queryObj = Bmob.Query('select');
  queryObj.set('place',place);
  queryObj.set('Date',date);
  queryObj.set('classtime',classtime);
  return queryObj;
}

function initline(getDataRes,array,classname,date,classtime){
  var getData = transfer.getData(getDataRes);
  const TaskArray = new Array();
  for(var i = 0 ; i < getData.length ; i++){
  var place=getData[i]["title"].slice(0,-3);
  var time=getData[i]["value"].slice(0,1);
  var queryData = array.filter(function (data) {return data.place == place});
  var queryData2=queryData.filter(function (data) {return data.classname == classtime});
  var Id=queryData[0]["Id"];
  var queryObj = Bmob.Query('TaskData');
  queryObj.set('placename',place);
  queryObj.set('timenum',time);
  queryObj.set('DataID',Id);
  TaskArray.push(queryObj);
  }
  Bmob.Query('TaskData').saveAll(TaskArray).then(result => {
    const IDArray = new Array();
    for(var i = 0 ; i < result.length ; i++){
      IDArray.push(result[i]["success"]["objectId"]);
    }
    const relation = Bmob.Relation('TaskData')
    const relID = relation.add(IDArray)
    const lineObj = Bmob.Query('line');
    lineObj.set('classname',classname);
    lineObj.set('classtime',classtime);
    lineObj.set('Date',date);
    lineObj.set('taskdatalist',relID);
    lineObj.save().then(res => {console.log(res)}).catch(err => {console.log(err)})

  }).catch(err => {console.log(err);});

}



util.event('lay-active', {
  e1: function(){
    layer.msg('初始化地区');
    const queryArray = new Array();
    for(var i = 0 ; i < placelist.length ; i++){
    queryArray.push(selectlist(placelist[i],'2021-05-19','早'));
    queryArray.push(selectlist(placelist[i],'2021-05-19','中'));
    queryArray.push(selectlist(placelist[i],'2021-05-19','晚'));
    }

    Bmob.Query('select').saveAll(queryArray).then(result => {
      const Array3= new Array();
      for(var i = 0 ; i < result.length ; i++){
        var Obj=new Object();
        Obj.place=queryArray[i]["setData"]["place"];
        Obj.time=queryArray[i]["setData"]["classname"];
        Obj.Id=result[i]["success"]["objectId"];
        Array3.push(Obj);
      }
      initline('key1',Array3,'A','2021-05-19','早');
      initline('key1',Array3,'A','2021-05-19','中');
      initline('key1',Array3,'A','2021-05-19','晚');
      initline('key2',Array3,'B','2021-05-19','早');
      initline('key2',Array3,'B','2021-05-19','中');
      initline('key2',Array3,'B','2021-05-19','晚');
      initline('key3',Array3,'C','2021-05-19','早');
      initline('key3',Array3,'C','2021-05-19','中');
      initline('key3',Array3,'C','2021-05-19','晚');
    }).catch(err => {console.log(err);});
  }
  ,e2: function(){
    layer.msg('触发了事件2');

  }
  ,e3: function(){
    layer.msg('触发了事件3');
  }
});


});
</script>
</body>
</html>
